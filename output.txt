Running Start

> doc-writer@1.0.0 start /opt/doc-executor
> NODE_PATH=app/src node app/index.js

{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Initializing doc-executor","time":"2018-10-15T19:07:15.965Z","src":{"file":"/opt/doc-executor/app/src/app.js","line":3},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":"Connecting to queue DOC-STATUS","time":"2018-10-15T19:07:16.038Z","src":{"file":"/opt/doc-executor/app/src/services/status-queue.service.js","line":13,"func":"StatusQueueService"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":"Connecting to queue DOC-DATA","time":"2018-10-15T19:07:16.371Z","src":{"file":"/opt/doc-executor/app/src/services/data-queue.service.js","line":17,"func":"DataQueueService"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":"Connecting to queue DOC-EXECUTOR-TASKS","time":"2018-10-15T19:07:16.597Z","src":{"file":"/opt/doc-executor/app/src/services/executor-queue.service.js","line":20,"func":"ExecutorQueueService"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":"Connected","time":"2018-10-15T19:07:16.668Z","src":{"file":"/opt/doc-executor/app/src/services/status-queue.service.js","line":16,"func":"StatusQueueService.init.then"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":"Connected","time":"2018-10-15T19:07:16.668Z","src":{"file":"/opt/doc-executor/app/src/services/data-queue.service.js","line":20,"func":"DataQueueService.init.then"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":" [*] Waiting for messages in DOC-EXECUTOR-TASKS","time":"2018-10-15T19:07:16.669Z","src":{"file":"/opt/doc-executor/app/src/services/executor-queue.service.js","line":40,"func":"init"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":"Connected","time":"2018-10-15T19:07:16.670Z","src":{"file":"/opt/doc-executor/app/src/services/executor-queue.service.js","line":23,"func":"ExecutorQueueService.init.then"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Message received {\"id\":\"d4275c6f-d2dc-462c-b98e-b577ec5d8fda\",\"type\":\"EXECUTION_CREATE\",\"taskId\":\"45ca2dd5-df97-44ac-8e23-ed44081c1ae1\",\"datasetId\":\"bb497b2e-856d-4dca-904c-be5ca6d3002f\",\"fileUrl\":\"https://www.apihighways.org/static/hxl.csv\",\"provider\":\"csv\",\"legend\":{\"nested\":[],\"country\":[],\"region\":[],\"date\":[]},\"verified\":false,\"dataPath\":null}","time":"2018-10-15T19:07:16.672Z","src":{"file":"/opt/doc-executor/app/src/services/executor-queue.service.js","line":66,"func":"consume"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"message content { id: 'd4275c6f-d2dc-462c-b98e-b577ec5d8fda',\n  type: 'EXECUTION_CREATE',\n  taskId: '45ca2dd5-df97-44ac-8e23-ed44081c1ae1',\n  datasetId: 'bb497b2e-856d-4dca-904c-be5ca6d3002f',\n  fileUrl: 'https://www.apihighways.org/static/hxl.csv',\n  provider: 'csv',\n  legend: { nested: [], country: [], region: [], date: [] },\n  verified: false,\n  dataPath: null }","time":"2018-10-15T19:07:16.673Z","src":{"file":"/opt/doc-executor/app/src/services/executor-queue.service.js","line":68,"func":"consume"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Create task","time":"2018-10-15T19:07:16.673Z","src":{"file":"/opt/doc-executor/app/src/services/executor.service.js","line":60,"func":"create"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Creating index","time":"2018-10-15T19:07:16.673Z","src":{"file":"/opt/doc-executor/app/src/services/executor.service.js","line":61,"func":"create"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Creating index index_bb497b2e856d4dca904cbe5ca6d3002f_1539630436673 and type type in elastic","time":"2018-10-15T19:07:16.673Z","src":{"file":"/opt/doc-executor/app/src/services/elastic.service.js","line":54,"func":"createIndex"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Sending index created message of taskId 45ca2dd5-df97-44ac-8e23-ed44081c1ae1 and index index_bb497b2e856d4dca904cbe5ca6d3002f_1539630436673","time":"2018-10-15T19:07:18.199Z","src":{"file":"/opt/doc-executor/app/src/services/status-queue.service.js","line":56,"func":"sendIndexCreated"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":"Sending message IndexCreatedMessage {\n  id: 'ac3f5c4c-4159-40c3-9a50-24ae4842a4a9',\n  type: 'STATUS_INDEX_CREATED',\n  taskId: '45ca2dd5-df97-44ac-8e23-ed44081c1ae1',\n  index: 'index_bb497b2e856d4dca904cbe5ca6d3002f_1539630436673' }","time":"2018-10-15T19:07:20.202Z","src":{"file":"/opt/doc-executor/app/src/services/status-queue.service.js","line":37,"func":"setInterval"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Starting importing service","time":"2018-10-15T19:07:20.205Z","src":{"file":"/opt/doc-executor/app/src/services/executor.service.js","line":69,"func":"create"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Starting read file","time":"2018-10-15T19:07:20.205Z","src":{"file":"/opt/doc-executor/app/src/services/importer.service.js","line":52,"func":"Promise"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":"Getting converter of type csv and dataPath null and url https://www.apihighways.org/static/hxl.csv","time":"2018-10-15T19:07:20.205Z","src":{"file":"/opt/doc-executor/app/src/services/converters/converterFactory.js","line":10,"func":"getInstance"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Is a url. Downloading file","time":"2018-10-15T19:07:20.206Z","src":{"file":"/opt/doc-executor/app/src/services/converters/csvConverter.js","line":26,"func":"init"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":"Checking if the url https://www.apihighways.org/static/hxl.csv exists","time":"2018-10-15T19:07:20.206Z","src":{"file":"/opt/doc-executor/app/src/services/downloadService.js","line":53,"func":"checkIfExists"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Headers  text/csv; charset=UTF-8 200","time":"2018-10-15T19:07:20.244Z","src":{"file":"/opt/doc-executor/app/src/services/downloadService.js","line":60,"func":"checkIfExists"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Downloading....","time":"2018-10-15T19:07:20.245Z","src":{"file":"/opt/doc-executor/app/src/services/downloadService.js","line":70,"func":"downloadFile"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Temporal path /tmp/a1t9qavTPjTjLHfpKLunB70YylzBGRAF.csv . Downloading","time":"2018-10-15T19:07:20.245Z","src":{"file":"/opt/doc-executor/app/src/services/downloadService.js","line":72,"func":"downloadFile"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Sending request","time":"2018-10-15T19:07:20.245Z","src":{"file":"/opt/doc-executor/app/src/services/downloadService.js","line":31},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":"File size: 17.8 KiB","time":"2018-10-15T19:07:20.275Z","src":{"file":"/opt/doc-executor/app/src/services/downloadService.js","line":35,"func":"download.then.data"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Downloaded file!!!","time":"2018-10-15T19:07:20.275Z","src":{"file":"/opt/doc-executor/app/src/services/downloadService.js","line":74,"func":"downloadFile"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Starting process file","time":"2018-10-15T19:07:20.277Z","src":{"file":"/opt/doc-executor/app/src/services/importer.service.js","line":62,"func":"Promise"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":30,"msg":"Removing file /tmp/a1t9qavTPjTjLHfpKLunB70YylzBGRAF.csv","time":"2018-10-15T19:07:20.290Z","src":{"file":"/opt/doc-executor/app/src/services/converters/csvConverter.js","line":55,"func":"readStream.on"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Body data: 302","time":"2018-10-15T19:07:20.290Z","src":{"file":"/opt/doc-executor/app/src/services/importer.service.js","line":69,"func":"stream.on"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"Finishing reading file","time":"2018-10-15T19:07:20.290Z","src":{"file":"/opt/doc-executor/app/src/services/importer.service.js","line":75,"func":"stream.on"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"colDataTypes: [ { key: '#country+name', value: 'STRING' },\n  { key: '#activity+appeal+id+fts_internal', value: 'NUMBER' },\n  { key: '#activity+appeal+name', value: 'STRING' },\n  { key: '#activity+appeal+id+external', value: 'STRING' },\n  { key: '#date+start', value: 'STRING' },\n  { key: '#date+end', value: 'STRING' },\n  { key: '#date+year', value: 'NUMBER' },\n  { key: '#sector+code', value: 'NUMBER' },\n  { key: '#sector+name', value: 'STRING' },\n  { key: '#value+funding+total+usd', value: 'NUMBER' },\n  { key: 'row_num', value: 'NUMBER' },\n  { key: '#country+name', value: 'STRING' },\n  { key: '#activity+appeal+id+fts_internal', value: 'NUMBER' },\n  { key: '#activity+appeal+name', value: 'STRING' },\n  { key: '#activity+appeal+id+external', value: 'STRING' },\n  { key: '#date+start', value: 'STRING' },\n  { key: '#date+end', value: 'STRING' },\n  { key: '#date+year', value: 'NUMBER' },\n  { key: '#sector+code', value: 'NUMBER' },\n  { key: '#sector+name', value: 'STRING' },\n  { key: '#value+funding+total+usd', value: 'NUMBER' },\n  { key: 'row_num', value: 'NUMBER' },\n  { key: '#country+name', value: 'STRING' },\n  { key: '#activity+appeal+id+fts_internal', value: 'NUMBER' },\n  { key: '#activity+appeal+name', value: 'STRING' },\n  { key: '#activity+appeal+id+external', value: 'STRING' },\n  { key: '#date+start', value: 'STRING' },\n  { key: '#date+end', value: 'STRING' },\n  { key: '#date+year', value: 'NUMBER' },\n  { key: '#sector+code', value: 'NUMBER' },\n  { key: '#sector+name', value: 'STRING' },\n  { key: '#value+funding+required+usd', value: 'NUMBER' },\n  { key: '#value+funding+total+usd', value: 'NUMBER' },\n  { key: '#value+funding+pct', value: 'NUMBER' },\n  { key: 'row_num', value: 'NUMBER' },\n  { key: '#country+name', value: 'STRING' },\n  { key: '#activity+appeal+id+fts_internal', value: 'NUMBER' },\n  { key: '#activity+appeal+name', value: 'STRING' },\n  { key: '#activity+appeal+id+external', value: 'STRING' },\n  { key: '#date+start', value: 'STRING' },\n  { key: '#date+end', value: 'STRING' },\n  { key: '#date+year', value: 'NUMBER' },\n  { key: '#sector+code', value: 'NUMBER' },\n  { key: '#sector+name', value: 'STRING' },\n  { key: '#value+funding+required+usd', value: 'NUMBER' },\n  { key: '#value+funding+total+usd', value: 'NUMBER' },\n  { key: '#value+funding+pct', value: 'NUMBER' },\n  { key: 'row_num', value: 'NUMBER' },\n  { key: '#country+name', value: 'STRING' },\n  { key: '#activity+appeal+id+fts_internal', value: 'NUMBER' },\n  { key: '#activity+appeal+name', value: 'STRING' },\n  { key: '#activity+appeal+id+external', value: 'STRING' },\n  { key: '#date+start', value: 'STRING' },\n  { key: '#date+end', value: 'STRING' },\n  { key: '#date+year', value: 'NUMBER' },\n  { key: '#sector+code', value: 'NUMBER' },\n  { key: '#sector+name', value: 'STRING' },\n  { key: '#value+funding+required+usd', value: 'NUMBER' },\n  { key: '#value+funding+total+usd', value: 'NUMBER' },\n  { key: '#value+funding+pct', value: 'NUMBER' },\n  { key: 'row_num', value: 'NUMBER' },\n  { key: '#country+name', value: 'STRING' },\n  { key: '#activity+appeal+id+fts_internal', value: 'NUMBER' },\n  { key: '#activity+appeal+name', value: 'STRING' },\n  { key: '#activity+appeal+id+external', value: 'STRING' },\n  { key: '#date+start', value: 'STRING' },\n  { key: '#date+end', value: 'STRING' },\n  { key: '#date+year', value: 'NUMBER' },\n  { key: '#sector+code', value: 'NUMBER' },\n  { key: '#sector+name', value: 'STRING' },\n  { key: '#value+funding+required+usd', value: 'NUMBER' },\n  { key: '#value+funding+total+usd', value: 'NUMBER' },\n  { key: '#value+funding+pct', value: 'NUMBER' },\n  { key: 'row_num', value: 'NUMBER' },\n  { key: '#country+name', value: 'STRING' },\n  { key: '#activity+appeal+id+fts_internal', value: 'NUMBER' },\n  { key: '#activity+appeal+name', value: 'STRING' },\n  { key: '#activity+appeal+id+external', value: 'STRING' },\n  { key: '#date+start', value: 'STRING' },\n  { key: '#date+end', value: 'STRING' },\n  { key: '#date+year', value: 'NUMBER' },\n  { key: '#sector+code', value: 'NUMBER' },\n  { key: '#sector+name', value: 'STRING' },\n  { key: '#value+funding+required+usd', value: 'NUMBER' },\n  { key: '#value+funding+total+usd', value: 'NUMBER' },\n  { key: '#value+funding+pct', value: 'NUMBER' },\n  { key: 'row_num', value: 'NUMBER' },\n  { key: '#country+name', value: 'STRING' },\n  { key: '#activity+appeal+id+fts_internal', value: 'NUMBER' },\n  { key: '#activity+appeal+name', value: 'STRING' },\n  { key: '#activity+appeal+id+external', value: 'STRING' },\n  { key: '#date+start', value: 'STRING' },\n  { key: '#date+end', value: 'STRING' },\n  { key: '#date+year', value: 'NUMBER' },\n  { key: '#sector+code', value: 'NUMBER' },\n  { key: '#sector+name', value: 'STRING' },\n  { key: '#value+funding+required+usd', value: 'NUMBER' },\n  { key: '#value+funding+total+usd', value: 'NUMBER' },\n  { key: '#value+funding+pct', value: 'NUMBER' },\n  { key: 'row_num', value: 'NUMBER' },\n  ... 512 more items ]","time":"2018-10-15T19:07:20.292Z","src":{"file":"/opt/doc-executor/app/src/services/importer.service.js","line":123,"func":"checkColumnDataTypes"},"v":0}
{"name":"doc-executor","hostname":"doc-executor-sdgs-5b67b69c9f-rkvnv","pid":17,"level":20,"msg":"first row: { '#country+name': 'Yemen',\n  '#activity+appeal+id+fts_internal': 657,\n  '#activity+appeal+name': 'Yemen 2018',\n  '#activity+appeal+id+external': 'HYEM18',\n  '#date+start': '1/1/2018',\n  '#date+end': '12/31/2018',\n  '#date+year': 2018,\n  '#sector+code': 26512,\n  '#sector+name': 'Agriculture',\n  '#value+funding+required+usd': '',\n  '#value+funding+total+usd': 20021069,\n  '#value+funding+pct': '',\n  row_num: 0 }","time":"2018-10-15T19:07:20.292Z","src":{"file":"/opt/doc-executor/app/src/services/importer.service.js","line":124,"func":"checkColumnDataTypes"},"v":0}
/opt/doc-executor/app/src/services/importer.service.js:130
                    this.body[1][key] = 0;
                                 ^

ReferenceError: key is not defined
    at colDataTypes.forEach.item (/opt/doc-executor/app/src/services/importer.service.js:130:34)
    at Array.forEach (<anonymous>)
    at ImporterService.checkColumnDataTypes (/opt/doc-executor/app/src/services/importer.service.js:127:22)
    at ParserStream.stream.on (/opt/doc-executor/app/src/services/importer.service.js:77:30)
    at emitOne (events.js:130:20)
    at ParserStream.emit (events.js:221:7)
    at spreadArgs (/opt/doc-executor/node_modules/fast-csv/lib/extended.js:43:25)
    at ParserStream.emit (/opt/doc-executor/node_modules/fast-csv/lib/parser/parser_stream.js:314:17)
    at endReadableNT (_stream_readable.js:1054:12)
    at _combinedTickCallback (internal/process/next_tick.js:138:11)
    at process._tickDomainCallback (internal/process/next_tick.js:218:9)
npm ERR! code ELIFECYCLE
npm ERR! errno 1
npm ERR! doc-writer@1.0.0 start: `NODE_PATH=app/src node app/index.js`
npm ERR! Exit status 1
npm ERR! 
npm ERR! Failed at the doc-writer@1.0.0 start script.
npm ERR! This is probably not a problem with npm. There is likely additional logging output above.

npm ERR! A complete log of this run can be found in:
npm ERR!     /home/doc-executor/.npm/_logs/2018-10-15T19_07_20_304Z-debug.log
